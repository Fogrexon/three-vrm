/*! (c) 2020-2021 pixiv Inc. - https://github.com/pixiv/three-vrm/blob/release/LICENSE */
!function(e,o){"object"==typeof exports&&"undefined"!=typeof module?o(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],o):o((e="undefined"!=typeof globalThis?globalThis:e||self).THREE_VRM_MATERIALS_V0COMPAT={},e.THREE)}(this,(function(e,o){"use strict";function i(e){if(e&&e.__esModule)return e;var o=Object.create(null);return e&&Object.keys(e).forEach((function(i){if("default"!==i){var t=Object.getOwnPropertyDescriptor(e,i);Object.defineProperty(o,i,t.get?t:{enumerable:!0,get:function(){return e[i]}})}})),o.default=e,Object.freeze(o)}var t=i(o);
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */function r(e,o,i,t){return new(i||(i=Promise))((function(r,n){function l(e){try{a(t.next(e))}catch(e){n(e)}}function s(e){try{a(t.throw(e))}catch(e){n(e)}}function a(e){var o;e.done?r(e.value):(o=e.value,o instanceof i?o:new i((function(e){e(o)}))).then(l,s)}a((t=t.apply(e,o||[])).next())}))}function n(e){return Math.pow(e,2.2)}e.VRMMaterialsV0CompatPlugin=class{constructor(e){var o;this.parser=e;const i=this.parser.json;i.extensionsUsed=null!==(o=i.extensionsUsed)&&void 0!==o?o:[],-1===i.extensionsUsed.indexOf("KHR_texture_transform")&&i.extensionsUsed.push("KHR_texture_transform")}get name(){return"VRMMaterialsV0CompatPlugin"}beforeRoot(){var e;return r(this,void 0,void 0,(function*(){const o=this.parser.json,i=null===(e=o.extensions)||void 0===e?void 0:e.VRM,t=null==i?void 0:i.materialProperties;t&&t.forEach(((e,i)=>{var t;if("VRM/MToon"===e.shader){const t=this._parseV0MToonProperties(e,o.materials[i]);o.materials[i]=t}else if(null===(t=e.shader)||void 0===t?void 0:t.startsWith("VRM/Unlit")){const t=this._parseV0UnlitProperties(e,o.materials[i]);o.materials[i]=t}else"VRM_USE_GLTFSHADER"===e.shader||console.warn(`VRMMaterialsV0CompatPlugin: Unknown shader: ${e.shader}`)}))}))}_parseV0MToonProperties(e,o){var i,r,l,s,a,d,u,v,p,c,f,_,h,x,m,P,M,T,g,R,b,O,C,A,V,j,S,y,F,E,U,L,W,w,Q,H,N,k,B,D,K,Z,I,q;const z=null!==(r=null===(i=e.keywordMap)||void 0===i?void 0:i._ALPHABLEND_ON)&&void 0!==r&&r,X=1===(null===(l=e.floatProperties)||void 0===l?void 0:l._ZWrite)&&z,Y=this._v0ParseRenderQueue(e),G=null!==(a=null===(s=e.keywordMap)||void 0===s?void 0:s._ALPHATEST_ON)&&void 0!==a&&a,$=z?"BLEND":G?"MASK":"OPAQUE",J=G?null===(d=e.floatProperties)||void 0===d?void 0:d._Cutoff:void 0,ee=0===(null!==(v=null===(u=e.floatProperties)||void 0===u?void 0:u._CullMode)&&void 0!==v?v:2),oe=this._portTextureTransform(e),ie=null===(c=null===(p=e.vectorProperties)||void 0===p?void 0:p._Color)||void 0===c?void 0:c.map(((e,o)=>3===o?e:n(e))),te=null===(f=e.textureProperties)||void 0===f?void 0:f._MainTex,re=null!=te?{index:te,extensions:Object.assign({},oe)}:void 0,ne=null===(_=e.floatProperties)||void 0===_?void 0:_._BumpScale,le=null===(h=e.textureProperties)||void 0===h?void 0:h._BumpMap,se=null!=le?{index:le,scale:ne,extensions:Object.assign({},oe)}:void 0,ae=null===(m=null===(x=e.vectorProperties)||void 0===x?void 0:x._EmissionColor)||void 0===m?void 0:m.map(n),de=null===(P=e.textureProperties)||void 0===P?void 0:P._EmissionMap,ue=null!=de?{index:de,extensions:Object.assign({},oe)}:void 0,ve=null===(T=null===(M=e.vectorProperties)||void 0===M?void 0:M._ShadeColor)||void 0===T?void 0:T.map(n),pe=null===(g=e.textureProperties)||void 0===g?void 0:g._ShadeTexture,ce=null!=pe?{index:pe,extensions:Object.assign({},oe)}:void 0;let fe=null!==(b=null===(R=e.floatProperties)||void 0===R?void 0:R._ShadeShift)&&void 0!==b?b:0,_e=null!==(C=null===(O=e.floatProperties)||void 0===O?void 0:O._ShadeToony)&&void 0!==C?C:.9;_e=t.MathUtils.lerp(_e,1,.5+.5*fe),fe=-fe-(1-_e);const he=null===(A=e.floatProperties)||void 0===A?void 0:A._IndirectLightIntensity,xe=he?1-he:void 0,me=null===(V=e.textureProperties)||void 0===V?void 0:V._SphereAdd,Pe=null!=me?{index:me}:void 0,Me=null===(j=e.floatProperties)||void 0===j?void 0:j._RimLightingMix,Te=null===(S=e.textureProperties)||void 0===S?void 0:S._RimTexture,ge=null!=Te?{index:Te,extensions:Object.assign({},oe)}:void 0,Re=null===(F=null===(y=e.vectorProperties)||void 0===y?void 0:y._RimColor)||void 0===F?void 0:F.map(n),be=null===(E=e.floatProperties)||void 0===E?void 0:E._RimFresnelPower,Oe=null===(U=e.floatProperties)||void 0===U?void 0:U._RimLift,Ce=["none","worldCoordinates","screenCoordinates"][null!==(W=null===(L=e.floatProperties)||void 0===L?void 0:L._OutlineWidthMode)&&void 0!==W?W:0];let Ae=null!==(Q=null===(w=e.floatProperties)||void 0===w?void 0:w._OutlineWidth)&&void 0!==Q?Q:0;Ae*=.01;const Ve=null===(H=e.textureProperties)||void 0===H?void 0:H._OutlineWidthTexture,je=null!=Ve?{index:Ve,extensions:Object.assign({},oe)}:void 0,Se=null===(k=null===(N=e.vectorProperties)||void 0===N?void 0:N._OutlineColor)||void 0===k?void 0:k.map(n),ye=1===(null===(B=e.floatProperties)||void 0===B?void 0:B._OutlineColorMode)?null===(D=e.floatProperties)||void 0===D?void 0:D._OutlineLightingMix:0,Fe=null===(K=e.textureProperties)||void 0===K?void 0:K._UvAnimMaskTexture,Ee=null!=Fe?{index:Fe,extensions:Object.assign({},oe)}:void 0,Ue=null===(Z=e.floatProperties)||void 0===Z?void 0:Z._UvAnimScrollX;let Le=null===(I=e.floatProperties)||void 0===I?void 0:I._UvAnimScrollY;null!=Le&&(Le=-Le);const We={specVersion:"1.0-beta",transparentWithZWrite:X,renderQueueOffsetNumber:Y,shadeColorFactor:ve,shadeMultiplyTexture:ce,shadingShiftFactor:fe,shadingToonyFactor:_e,giEqualizationFactor:xe,matcapTexture:Pe,rimLightingMixFactor:Me,rimMultiplyTexture:ge,parametricRimColorFactor:Re,parametricRimFresnelPowerFactor:be,parametricRimLiftFactor:Oe,outlineWidthMode:Ce,outlineWidthFactor:Ae,outlineWidthMultiplyTexture:je,outlineColorFactor:Se,outlineLightingMixFactor:ye,uvAnimationMaskTexture:Ee,uvAnimationScrollXSpeedFactor:Ue,uvAnimationScrollYSpeedFactor:Le,uvAnimationRotationSpeedFactor:null===(q=e.floatProperties)||void 0===q?void 0:q._UvAnimRotation};return Object.assign(Object.assign({},o),{pbrMetallicRoughness:{baseColorFactor:ie,baseColorTexture:re},normalTexture:se,emissiveTexture:ue,emissiveFactor:ae,alphaMode:$,alphaCutoff:J,doubleSided:ee,extensions:{VRMC_materials_mtoon:We}})}_parseV0UnlitProperties(e,o){var i,t,r,l;const s="VRM/UnlitTransparentZWrite"===e.shader,a="VRM/UnlitTransparent"===e.shader||s,d=this._v0ParseRenderQueue(e),u="VRM/UnlitCutout"===e.shader,v=a?"BLEND":u?"MASK":"OPAQUE",p=u?null===(i=e.floatProperties)||void 0===i?void 0:i._Cutoff:void 0,c=this._portTextureTransform(e),f=null===(r=null===(t=e.vectorProperties)||void 0===t?void 0:t._Color)||void 0===r?void 0:r.map(n),_=null===(l=e.textureProperties)||void 0===l?void 0:l._MainTex,h=null!=_?{index:_,extensions:Object.assign({},c)}:void 0,x={specVersion:"1.0-beta",transparentWithZWrite:s,renderQueueOffsetNumber:d,shadeColorFactor:f,shadeMultiplyTexture:h};return Object.assign(Object.assign({},o),{pbrMetallicRoughness:{baseColorFactor:f,baseColorTexture:h},alphaMode:v,alphaCutoff:p,extensions:{VRMC_materials_mtoon:x}})}_portTextureTransform(e){var o,i,t,r,n;const l=null===(o=e.vectorProperties)||void 0===o?void 0:o._MainTex;if(null==l)return{};const s=[null!==(i=null==l?void 0:l[0])&&void 0!==i?i:0,null!==(t=null==l?void 0:l[1])&&void 0!==t?t:0],a=[null!==(r=null==l?void 0:l[2])&&void 0!==r?r:1,null!==(n=null==l?void 0:l[3])&&void 0!==n?n:1];return s[1]=a[1]*(1-s[1])%1,{KHR_texture_transform:{offset:s,scale:a}}}_v0ParseRenderQueue(e){var o,i,t;const r=null!==(i=null===(o=e.keywordMap)||void 0===o?void 0:o._ALPHABLEND_ON)&&void 0!==i&&i,n=1===(null===(t=e.floatProperties)||void 0===t?void 0:t._ZWrite);let l=0;return r&&e.renderQueue&&(l=n?Math.min(Math.max(e.renderQueue-2501,0),9):Math.min(Math.max(e.renderQueue-3e3,-9),0)),l}},Object.defineProperty(e,"__esModule",{value:!0}),Object.assign(o,e)}));
